<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EcoFinds — Secondhand Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Configure Tailwind CSS for dark mode
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {}
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body class="bg-pink-50 dark:bg-gray-900 dark:text-white">
  <div id="root" class="min-h-screen"></div>

  <!-- Load Firebase config -->
  <script src="config.js"></script>

<script type="text/babel">
const { useState, useEffect } = React;

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

/* ---------- Helpers ---------- */
const formatINR = (num) => {
  return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(num);
};

/* ---------- Data ---------- */
const CATEGORIES = ['All', 'Clothing', 'Electronics', 'Furniture', 'Books', 'Toys', 'Appliances', 'Accessories', 'Sports'];

const SAMPLE_PRODUCTS = [
  { id: 1, title: 'Vintage Denim Jacket', description: 'Lightly worn retro denim jacket...', category: 'Clothing', price: 999, sellerId: 10, condition: 'Good', brand: 'Levi\'s', images: ['https://images.unsplash.com/photo-1551488831-00ddcb6c6bd3', 'https://images.unsplash.com/photo-1565084888279-15199057f27d', 'ttps://images.unsplash.com/photo-1525171254930-643fc83d3c36'] },
  { id: 2, title: 'Used Laptop (13")', description: 'Factory reset, charger included...', category: 'Electronics', price: 10999, sellerId: 11, condition: 'Very Good', brand: 'Dell', images: ['https://images.unsplash.com/photo-1496181133206-80ce9b88a853', 'https://images.unsplash.com/photo-1516321497487-e288fb19713f', 'https://images.unsplash.com/photo-1541807084-5c52b6b3adef'] },
  { id: 4, title: 'Vintage DSLR Body', description: 'Entry-level DSLR, shutter ~22k...', category: 'Electronics', price: 13999, sellerId: 13, condition: 'Good', brand: 'Canon', images: ['https://images.unsplash.com/photo-1516035069371-29a1b244cc32', 'https://images.unsplash.com/photo-1509233725247-49e657c5c70d', 'https://images.unsplash.com/photo-1524578271613-d550e6379e65'] },
  { id: 7, title: 'Kitchen Mixer — Secondhand', description: 'Working condition, includes extra bowl...', category: 'Appliances', price: 3499, sellerId: 16, condition: 'Very Good', brand: 'Philips', images: ['https://images.unsplash.com/photo-1600585154340-be6161a56a0c', 'https://images.unsplash.com/photo-1556911220-bff31c4c6e90', 'https://images.unsplash.com/photo-1596040024980-7d6e50b3adad'] },
  { id: 8, title: 'Vintage Leather Bag', description: 'Classic leather satchel — good condition...', category: 'Accessories', price: 2569, sellerId: 17, condition: 'Good', brand: 'Fossil', images: ['https://images.unsplash.com/photo-1553062407-98eeb64c6a62', 'https://images.unsplash.com/photo-1590874103328-eac38a683ce7', 'https://images.unsplash.com/photo-1601924332907-fb6b5a9b6762'] },
  { id: 9, title: 'Pre-Loved Running Shoes', description: 'Comfortable running shoes, lightly used...', category: 'Sports', price: 2449, sellerId: 18, condition: 'Very Good', brand: 'Nike', images: ['https://images.unsplash.com/photo-1542291026-7eec264c27ff', 'https://images.unsplash.com/photo-1549298916-b4d3d3a3b7a7', 'https://images.unsplash.com/photo-1595950653106-6c9ebd18f8f8'] },
  { id: 10, title: 'Vintage Wristwatch', description: 'Classic analog wristwatch, minor scratches...', category: 'Accessories', price: 7499, sellerId: 19, condition: 'Good', brand: 'Seiko', images: ['https://images.unsplash.com/photo-1522312346375-d1a52e2b99b3', 'https://images.unsplash.com/photo-1542496658-e18a7adac36b', 'https://images.unsplash.com/photo-1524592094714-0f25c50233b3'] },
  { id: 11, title: 'Secondhand Blender', description: 'Works perfectly, minor scratches on body...', category: 'Appliances', price: 1999, sellerId: 20, condition: 'Very Good', brand: 'Bosch', images: [ 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c','https://images.unsplash.com/photo-1556911220-bff31c4c6e90', 'https://images.unsplash.com/photo-1596040024980-7d6e50b3e1ad'] },
  { id: 13, title: 'Used Tablet 10"', description: 'Good condition, charger included...', category: 'Electronics', price: 11999, sellerId: 22, condition: 'Very Good', brand: 'Samsung', images: ['https://images.unsplash.com/photo-1516321497487-e288fb19713f','https://images.unsplash.com/photo-1544244015-1e6a674b7f24', 'https://images.unsplash.com/photo-1593642532973-d31b97d0eb4c' ] },
  { id: 15, title: 'Kids Toy Set', description: 'Pre-loved, all pieces intact...', category: 'Toys', price: 1299, sellerId: 24, condition: 'Very Good', brand: 'Lego', images: ['https://images.unsplash.com/photo-1587654780291-39c9404d746b', 'https://images.unsplash.com/photo-1580245830783-7c7b2e4d0934', 'https://images.unsplash.com/photo-1601924332907-fb6b5a9b6762'] },
  { id: 16, title: 'Pre-Loved Formal Shirt', description: 'Slim fit, lightly used...', category: 'Clothing', price: 499, sellerId: 25, condition: 'Very Good', brand: 'Arrow', images: ['https://images.unsplash.com/photo-1521572163474-6864f9cf17ab','https://images.unsplash.com/photo-1598033129183-8b0da7c44cec', 'https://images.unsplash.com/photo-1603251578711-3e935a0acdf8'] },
  { id: 17, title: 'Used Headphones', description: 'Noise-cancelling, lightly used...', category: 'Electronics', price: 2599, sellerId: 26, condition: 'Very Good', brand: 'Sony', images: ['https://images.unsplash.com/photo-1505740420928-5e560c06d30e', 'https://images.unsplash.com/photo-1611651238477-68e7c2c7b71b', 'https://images.unsplash.com/photo-1590658268034-6bf121059a7c'] },
  { id: 20, title: 'Secondhand Gaming Console', description: 'PS4 console, 2 controllers, good condition...', category: 'Electronics', price: 10999, sellerId: 29, condition: 'Good', brand: 'Sony', images: [ 'https://images.unsplash.com/photo-1516321497487-e288fb19713f','https://images.unsplash.com/photo-1612287230202-1ff1d85d5408', 'https://images.unsplash.com/photo-1593642532973-d31b97d0eb4c'] },
  { id: 21, title: 'Vintage Sunglasses', description: 'Classic aviator sunglasses...', category: 'Accessories', price: 1099, sellerId: 30, condition: 'Good', brand: 'Ray-Ban', images: ['https://images.unsplash.com/photo-1511499767150-a48a237f0083', 'https://images.unsplash.com/photo-1509048194-1046ed1e39b0', 'https://images.unsplash.com/photo-1533907657477-66b6d3d9c33d'] },
  { id: 24, title: 'Pre-Loved Hoodie', description: 'Comfy hoodie, lightly worn...', category: 'Clothing', price: 799, sellerId: 33, condition: 'Very Good', brand: 'H&M', images: ['https://images.unsplash.com/photo-1521572163474-6864f9cf17ab', 'https://images.unsplash.com/photo-1518013431117-eb1462fa5752', 'https://images.unsplash.com/photo-1598033129183-8b0da7c44cec'] },
  { id: 25, title: 'Used Smartwatch', description: 'Tracks steps and heart rate...', category: 'Electronics', price: 4999, sellerId: 34, condition: 'Good', brand: 'Apple', images: ['https://images.unsplash.com/photo-1546868871-7041f2a55e12', 'https://images.unsplash.com/photo-1590658268034-6bf121059a7c', 'https://images.unsplash.com/photo-1613040809024-b4ef7ba571a1'] },
  { id: 29, title: 'Pre-Loved Sneakers', description: 'Comfortable running shoes...', category: 'Clothing', price: 1799, sellerId: 38, condition: 'Very Good', brand: 'Adidas', images: ['https://images.unsplash.com/photo-1542291026-7eec264c27ff','https://images.unsplash.com/photo-1549298916-b4d3d3a3b7a7' , 'https://images.unsplash.com/photo-1595950653106-6c9ebd18f8f8'] },
  { id: 33, title: 'Pre-Loved Backpack', description: 'Durable, lightly used...', category: 'Accessories', price: 1999, sellerId: 42, condition: 'Very Good', brand: 'North Face', images: ['https://images.unsplash.com/photo-1553062407-98eeb64c6a62', 'https://images.unsplash.com/photo-1590874103328-eac38a683ce7', 'https://images.unsplash.com/photo-1601924332907-fb6b5a9b6762'] },
  { id: 35, title: 'Pre-Loved Puzzle Set', description: '1000-piece puzzle, complete set...', category: 'Toys', price: 499, sellerId: 44, condition: 'Very Good', brand: 'Ravensburger', images: ['https://images.unsplash.com/photo-1587654780291-39c9404d746b', 'https://images.unsplash.com/photo-1580245830783-7c7b2e4d0934', 'https://images.unsplash.com/photo-1601924332907-fb6b5a9b6762'] },
  { id: 37, title: 'Pre-Loved T-shirt', description: 'Casual cotton t-shirt...', category: 'Clothing', price: 499, sellerId: 46, condition: 'Very Good', brand: 'Uniqlo', images: ['https://images.unsplash.com/photo-1521572163474-6864f9cf17ab', 'https://images.unsplash.com/photo-1598033129183-8b0da7c44cec', 'https://images.unsplash.com/photo-1518013431117-eb1462fa5752'] },
  { id: 38, title: 'Used Bluetooth Speaker', description: 'Portable, works well...', category: 'Electronics', price: 1599, sellerId: 47, condition: 'Good', brand: 'JBL', images: ['https://images.unsplash.com/photo-1541185933-ef5d8ed016c2', 'https://images.unsplash.com/photo-1590658268034-6bf121059a7c', 'https://images.unsplash.com/photo-1613040809024-b4ef7ba571a1'] },
  
];

/* ---------- Banner Carousel ---------- */
function BannerCarousel() {
  const banners = [
    { type: 'text', content: 'EcoFinds: Your one-stop shop for secondhand treasures! Sustainable shopping made simple.' },
    { type: 'image', src: 'https://images.unsplash.com/photo-1516321497487-e288fb19713f', alt: 'Secondhand market' },
    { type: 'image', src: 'https://images.unsplash.com/photo-1525171254930-643fc83d3c36', alt: 'Vintage clothing' },
    { type: 'image', src: 'https://images.unsplash.com/photo-1496181133206-80ce9b88a853', alt: 'Used electronics' }
  ];

  const [current, setCurrent] = useState(0);

  useEffect(() => {
    const interval = setInterval(() => {
      setCurrent((prev) => (prev + 1) % banners.length);
    }, 5000);
    return () => clearInterval(interval);
  }, []);

  const goPrev = () => setCurrent((prev) => (prev - 1 + banners.length) % banners.length);
  const goNext = () => setCurrent((prev) => (prev + 1) % banners.length);

  return (
    <div className="relative h-64 mb-6 overflow-hidden rounded-xl">
      {banners.map((banner, i) => (
        <div key={i} className={`absolute inset-0 transition-opacity duration-500 ${i === current ? 'opacity-100' : 'opacity-0'}`}>
          {banner.type === 'text' ? (
            <div className="flex items-center justify-center h-full bg-gradient-to-r from-purple-500 to-blue-500 text-white text-2xl sm:text-3xl font-bold p-4 text-center">
              {banner.content}
            </div>
          ) : (
            <img src={banner.src} alt={banner.alt} className="w-full h-full object-cover" />
          )}
        </div>
      ))}
      <button onClick={goPrev} className="absolute left-4 top-1/2 transform -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75">
        ←
      </button>
      <button onClick={goNext} className="absolute right-4 top-1/2 transform -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75">
        →
      </button>
    </div>
  );
}

/* ---------- Wishlist Screen ---------- */
function WishlistScreen({ wishlist, onBack, onOpen, onToggleWishlist }) {
  return (
    <div className="max-w-3xl mx-auto bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-2xl font-bold">Your Wishlist</h2>
        <button className="text-blue-500" onClick={onBack}>Back to Home</button>
      </div>
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        {wishlist.length === 0 && <div className="p-4 bg-gray-100 dark:bg-gray-700 rounded">Your wishlist is empty.</div>}
        {wishlist.map(p => (
          <div key={p.id} className="bg-white dark:bg-gray-800 rounded-xl shadow p-3 cursor-pointer relative">
            <div className="absolute top-2 right-2">
              <button onClick={(e) => { e.stopPropagation(); onToggleWishlist(p.id); }} className="text-red-500 hover:text-red-600">
                ♥
              </button>
            </div>
            <div onClick={() => onOpen(p.id)}>
              <div className="h-44 mb-3 relative">
                <img src={p.images[0]} alt={p.title} className="w-full h-full object-cover rounded border-2 border-black" />
              </div>
              <h3 className="font-semibold text-lg">{p.title}</h3>
              <div className="flex items-center justify-between mt-2">
                <div className="text-sm text-gray-600 dark:text-gray-300">{p.category}</div>
                <div className="font-bold text-purple-700">{formatINR(p.price)}</div>
              </div>
              <div className="text-xs text-gray-400 mt-2">Secondhand • {p.condition}</div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

/* ---------- App ---------- */
function App() {
  const [user, setUser] = useState(null); // Firebase user object
  const [products, setProducts] = useState(SAMPLE_PRODUCTS);
  const [cart, setCart] = useState([]); // {product, quantity}
  const [wishlist, setWishlist] = useState([]); // Array of product IDs
  const [screen, setScreen] = useState('home'); // 'home', 'product', 'cart', 'checkout', 'add', 'profile', 'edit', 'wishlist'
  const [selectedProductId, setSelectedProductId] = useState(null);
  const [productChats, setProductChats] = useState({}); // {productId: [{text, sender, ts}]}
  const [dark, setDark] = useState(false);
  const [categoryFilter, setCategoryFilter] = useState('All');
  const [filtersOpen, setFiltersOpen] = useState(false);
  const [editingProductId, setEditingProductId] = useState(null); // Track product being edited

  useEffect(() => {
    // Apply dark mode class to html element
    document.documentElement.classList.toggle('dark', dark);
    // Force re-render by updating a CSS property to ensure dark mode applies
    document.documentElement.style.colorScheme = dark ? 'dark' : 'light';
  }, [dark]);

  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(fbUser => {
      if (fbUser) {
        setUser({
          id: fbUser.uid,
          name: fbUser.displayName || fbUser.email,
          email: fbUser.email
        });
        setScreen('home');
      } else {
        window.location.href = 'index.html'; // Redirect to login if not authenticated
      }
    });
    return () => unsubscribe();
  }, []);

  /* Cart */
  function addToCart(product, qty = 1) {
    setCart((prev) => {
      const exist = prev.find(i => i.product.id === product.id);
      if (exist) return prev.map(i => i.product.id === product.id ? { ...i, quantity: i.quantity + qty } : i);
      return [...prev, { product, quantity: qty }];
    });
  }
  function updateCart(productId, qty) {
    setCart(prev => prev.map(i => i.product.id === productId ? { ...i, quantity: Math.max(1, qty) } : i));
  }
  function removeCart(productId) {
    setCart(prev => prev.filter(i => i.product.id !== productId));
  }

  /* Wishlist */
  function toggleWishlist(productId) {
    setWishlist(prev => {
      if (prev.includes(productId)) {
        return prev.filter(id => id !== productId);
      } else {
        return [...prev, productId];
      }
    });
  }

  /* Add Product */
  function createProduct(data) {
    const id = products.length ? Math.max(...products.map(p => p.id)) + 1 : 1;
    const newP = { ...data, id, sellerId: user?.id || 999 };
    setProducts(prev => [newP, ...prev]);
    setScreen('home');
  }

  /* Edit Product */
  function updateProduct(productId, data) {
    setProducts(prev => prev.map(p => p.id === productId ? { ...data, id: p.id, sellerId: p.sellerId } : p));
    setScreen('profile');
  }

  /* Remove Product */
  function removeProduct(productId) {
    setProducts(prev => prev.filter(p => p.id !== productId));
    setWishlist(prev => prev.filter(id => id !== productId)); // Remove from wishlist if present
  }

  /* Checkout */
  function placeOrder({ address, payment }) {
    if (!user) { alert('Please log in to purchase'); return; }
    alert('Order placed (demo). Thank you!');
    setCart([]);
    setScreen('home');
  }

  /* Chat */
  function sendProductChat(productId, text, sender = 'buyer') {
    setProductChats(prev => {
      const next = { ...prev };
      next[productId] = [...(next[productId] || []), { text, sender, ts: Date.now() }];
      return next;
    });
  }

  /* Filtering */
  const visibleProducts = products.filter(p => categoryFilter === 'All' ? true : p.category === categoryFilter);
  const wishlistProducts = products.filter(p => wishlist.includes(p.id));

  /* Router helpers */
  function openProduct(productId) { setSelectedProductId(productId); setScreen('product'); }
  function openEditProduct(productId) { setEditingProductId(productId); setScreen('edit'); }

  return (
    <div className="min-h-screen p-4 container mx-auto flex flex-col">
      {/* Header */}
      <header className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <h1 className="text-2xl font-extrabold text-purple-700 cursor-pointer" onClick={() => { setScreen('home'); setCategoryFilter('All'); }}>EcoFinds </h1>
          <nav className="hidden sm:flex gap-2">
            {CATEGORIES.map(cat => (
              <button key={cat} onClick={() => { setCategoryFilter(cat); setScreen('home'); }} className={`px-3 py-1 rounded-full ${categoryFilter === cat ? 'bg-purple-300 text-white' : 'bg-gray-200 dark:bg-gray-700'}`}>
                {cat}
              </button>
            ))}
          </nav>
        </div>

        <div className="flex items-center gap-3">
          <button className="bg-pink-200 hover:bg-pink-300 px-3 py-2 rounded-lg" onClick={() => setScreen('cart')}>🛒 Cart <span className="ml-1 text-sm bg-red-500 text-white rounded-full px-2">{cart.length}</span></button>
          <button className="bg-red-200 hover:bg-red-300 px-3 py-2 rounded-lg" onClick={() => setScreen('wishlist')}>♥ Wishlist <span className="ml-1 text-sm bg-red-500 text-white rounded-full px-2">{wishlist.length}</span></button>
          <button className="bg-blue-200 hover:bg-blue-300 px-3 py-2 rounded-lg" onClick={() => setScreen('add')}>+ Sell</button>
          {user ? (
            <div className="flex items-center gap-2">
              <button className="bg-green-200 hover:bg-green-300 w-10 h-10 flex items-center justify-center rounded-full text-xl font-bold" title="View Profile" onClick={() => setScreen('profile')}>
                {user.name ? user.name[0].toUpperCase() : '?'}
              </button>
              <button className="bg-gray-200 dark:bg-gray-700 px-2 py-2 rounded" title="Toggle dark" onClick={() => setDark(s => !s)}>🌓</button>
            </div>
          ) : null}
        </div>
      </header>

      {/* Main */}
      <main className="flex-grow">
        {screen === 'home' && (
          <Home
            products={visibleProducts}
            onOpen={openProduct}
            setCategoryFilter={setCategoryFilter}
            categoryFilter={categoryFilter}
            onOpenFilters={() => setFiltersOpen(s => !s)}
            filtersOpen={filtersOpen}
            setScreen={setScreen}
            onToggleWishlist={toggleWishlist}
            wishlist={wishlist}
          />
        )}
        {screen === 'product' && selectedProductId && (
          <ProductDetail
            product={products.find(p => p.id === selectedProductId)}
            onBack={() => setScreen('home')}
            onAddToCart={addToCart}
            chats={productChats[selectedProductId] || []}
            onSendChat={(text) => sendProductChat(selectedProductId, text, 'buyer')}
            setScreen={setScreen}
          />
        )}
        {screen === 'cart' && <CartScreen cart={cart} onBack={() => setScreen('home')} onUpdate={updateCart} onRemove={removeCart} onCheckout={() => setScreen('checkout')} />}
        {screen === 'checkout' && <Checkout onBack={() => setScreen('cart')} onPlace={placeOrder} cart={cart} />}
        {screen === 'add' && <AddProductForm onBack={() => setScreen('home')} onCreate={createProduct} />}
        {screen === 'edit' && editingProductId && (
          <EditProductForm
            product={products.find(p => p.id === editingProductId)}
            onBack={() => setScreen('profile')}
            onUpdate={(data) => updateProduct(editingProductId, data)}
          />
        )}
        {screen === 'profile' && (
          <Profile
            user={user}
            onBack={() => setScreen('home')}
            onLogout={() => auth.signOut()}
            purchases={[]}
            products={products}
            onRemove={removeProduct}
            onEdit={openEditProduct}
          />
        )}
        {screen === 'wishlist' && (
          <WishlistScreen
            wishlist={wishlistProducts}
            onBack={() => setScreen('home')}
            onOpen={openProduct}
            onToggleWishlist={toggleWishlist}
          />
        )}
      </main>

      {/* Footer */}
      <footer className="mt-8 py-4 text-center bg-purple-600 text-white text-sm">
        All rights reserved © CodeHolics 2025
      </footer>

      {/* Floating global support chat */}
      <FloatingSupportChat />
    </div>
  );
}

/* ---------- Components ---------- */

function Home({ products, onOpen, setCategoryFilter, categoryFilter, onOpenFilters, filtersOpen, setScreen, onToggleWishlist, wishlist }) {
  const [search, setSearch] = useState('');
  const [sortBy, setSortBy] = useState('relevance');

  // Filter products by search and category, then sort by price if applicable
  const filtered = products
    .filter(p => p.title.toLowerCase().includes(search.toLowerCase()))
    .sort((a, b) => {
      if (sortBy === 'priceLow') return a.price - b.price;
      if (sortBy === 'priceHigh') return b.price - a.price;
      return 0; // Default (relevance) - no sorting
    });

  return (
    <div>
      <BannerCarousel />
      <div className="flex gap-2 mb-4">
        <input value={search} onChange={e => setSearch(e.target.value)} className="flex-1 p-2 border rounded dark:bg-gray-700 dark:text-white" placeholder="Search products..." />
        <button className="bg-gray-200 dark:bg-gray-700 px-3 py-2 rounded" onClick={onOpenFilters}>Filters</button>
        <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="border rounded px-2 py-2 dark:bg-gray-700 dark:text-white">
          <option value="relevance">Relevance</option>
          <option value="priceLow">Price: Low to High</option>
          <option value="priceHigh">Price: High to Low</option>
        </select>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
        {filtered.map(p => (
          <div key={p.id} className="bg-white dark:bg-gray-800 rounded-xl shadow p-3 cursor-pointer relative" onClick={() => onOpen(p.id)}>
            <div className="absolute top-2 right-2">
              <button onClick={(e) => { e.stopPropagation(); onToggleWishlist(p.id); }} className={`text-2xl ${wishlist.includes(p.id) ? 'text-red-500' : 'text-gray-400'}`}>
                {wishlist.includes(p.id) ? '♥' : '♡'}
              </button>
            </div>
            <div className="h-44 mb-3 relative">
              <img src={p.images[0]} alt={p.title} className="w-full h-full object-cover rounded border-2 border-black" />
            </div>
            <h3 className="font-semibold text-lg">{p.title}</h3>
            <div className="flex items-center justify-between mt-2">
              <div className="text-sm text-gray-600 dark:text-gray-300">{p.category}</div>
              <div className="font-bold text-purple-700">{formatINR(p.price)}</div>
            </div>
            <div className="text-xs text-gray-400 mt-2">Secondhand • {p.condition}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

function ProductDetail({ product, onBack, onAddToCart, chats, onSendChat, setScreen }) {
  const [active, setActive] = useState(0);
  const [qty, setQty] = useState(1);
  const [chatOpen, setChatOpen] = useState(false);
  const [chatInput, setChatInput] = useState('');

  if (!product) return null;

  function postChat() {
    if (!chatInput.trim()) return;
    onSendChat(chatInput.trim());
    setChatInput('');
  }

  return (
    <div className="max-w-3xl mx-auto bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-2xl font-bold text-purple-700">{product.title}</h2>
        <div>
          <button className="text-blue-500 mr-2" onClick={() => setScreen('home')}>Home</button>
          <button className="text-blue-500" onClick={onBack}>Back</button>
        </div>
      </div>
      <div className="flex items-start gap-4">
        <div className="w-2/3">
          <img src={product.images[active]} alt="main" className="w-full h-72 object-cover rounded border-2 border-black" />
          <div className="flex gap-2 mt-3 overflow-x-auto">
            {product.images.map((src, i) => (
              <button key={i} onClick={() => setActive(i)} className={`h-20 w-28 flex-shrink-0 rounded overflow-hidden border-2 ${i === active ? 'border-purple-500' : 'border-black'}`}>
                <img src={src} className="w-full h-full object-cover" />
              </button>
            ))}
          </div>
        </div>

        <aside className="w-1/3">
          <div className="text-lg font-semibold mt-2">{formatINR(product.price)}</div>
          <div className="text-sm text-gray-500 dark:text-gray-300 mt-1">{product.condition} • {product.brand || ''}</div>

          <div className="mt-4">
            <div className="flex items-center gap-2 justify-center mb-2">
              <button onClick={() => setQty(q => Math.max(1, q - 1))} className="bg-pink-200 px-2 rounded">-</button>
              <div className="font-semibold">{qty}</div>
              <button onClick={() => setQty(q => q + 1)} className="bg-green-200 px-2 rounded">+</button>
            </div>
            <div className="flex justify-center">
              <button onClick={() => onAddToCart(product, qty)} className="bg-green-300 hover:bg-green-400 text-white px-6 py-2 rounded-md">Add to cart</button>
            </div>
          </div>

          <div className="mt-4">
            <button onClick={() => setChatOpen(s => !s)} className="w-full bg-blue-200 py-2 rounded">Chat with seller</button>
            {chatOpen && (
              <div className="mt-2 bg-gray-100 dark:bg-gray-700 p-2 rounded">
                <div className="h-32 overflow-y-auto mb-2">
                  {(chats || []).map((m, i) => (
                    <div key={i} className={`p-2 rounded mb-1 ${m.sender === 'seller' ? 'bg-green-100' : 'bg-blue-100'} max-w-[80%]`}>
                      {m.text}
                    </div>
                  ))}
                </div>
                <div className="flex gap-2">
                  <input value={chatInput} onChange={e => setChatInput(e.target.value)} className="flex-1 p-2 rounded dark:bg-gray-600 dark:text-white" placeholder="Message seller..." />
                  <button onClick={postChat} className="bg-purple-300 px-3 rounded text-white">Send</button>
                </div>
              </div>
            )}
          </div>
        </aside>
      </div>

      <section className="mt-6">
        <h3 className="text-xl font-semibold">Details</h3>
        <div className="text-gray-700 dark:text-gray-300 mt-2">
          <p><strong>Description:</strong> {product.description}</p>
          <p><strong>Category:</strong> {product.category}</p>
          <p><strong>Price:</strong> {formatINR(product.price)}</p>
          <p><strong>Seller ID:</strong> {product.sellerId}</p>
          <p><strong>Condition:</strong> {product.condition}</p>
          <p><strong>Brand:</strong> {product.brand || 'N/A'}</p>
        </div>
      </section>
    </div>
  );
}

function CartScreen({ cart, onBack, onUpdate, onRemove, onCheckout }) {
  const total = cart.reduce((s, i) => s + i.product.price * i.quantity, 0);
  return (
    <div className="max-w-3xl mx-auto bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-2xl font-bold">Your Cart</h2>
        <button className="text-blue-500" onClick={onBack}>Continue shopping</button>
      </div>

      <div className="space-y-3">
        {cart.length === 0 && <div className="p-4 bg-gray-100 dark:bg-gray-700 rounded">Your cart is empty.</div>}
        {cart.map(item => (
          <div key={item.product.id} className="flex gap-3 items-center bg-gray-50 dark:bg-gray-700 p-3 rounded">
            <img src={item.product.images[0]} className="w-28 h-20 object-cover rounded border border-black" />
            <div className="flex-1">
              <div className="font-semibold">{item.product.title}</div>
              <div className="text-sm text-gray-500 dark:text-gray-300">{formatINR(item.product.price)}</div>
              <div className="mt-2 flex items-center gap-2">
                <button onClick={() => onUpdate(item.product.id, item.quantity - 1)} className="bg-pink-200 px-2 rounded">-</button>
                <div>{item.quantity}</div>
                <button onClick={() => onUpdate(item.product.id, item.quantity + 1)} className="bg-green-200 px-2 rounded">+</button>
                <button onClick={() => onRemove(item.product.id)} className="ml-4 text-red-500">Remove</button>
              </div>
            </div>
            <div className="font-semibold">{formatINR(item.product.price * item.quantity)}</div>
          </div>
        ))}
      </div>

      <div className="mt-4 flex justify-between items-center">
        <div className="text-xl">Total: <span className="font-bold">{formatINR(total)}</span></div>
        <div>
          <button onClick={onCheckout} className="bg-yellow-300 px-4 py-2 rounded">Proceed to Checkout</button>
        </div>
      </div>
    </div>
  );
}

function Checkout({ cart, onBack, onPlace }) {
  const [addr, setAddr] = useState({ name: '', line1: '', city: '', zip: '' });
  const [method, setMethod] = useState('card');
  const [card, setCard] = useState({ num: '', name: '', exp: '', cvv: '' });
  const total = cart.reduce((s, i) => s + i.product.price * i.quantity, 0);

  function place() {
    if (!addr.name || !addr.line1) { alert('Please fill address'); return; }
    if (method === 'card' && (!card.num || !card.name)) { alert('Enter card details'); return; }
    onPlace({ address: addr, payment: { method, card: method === 'card' ? { ...card, last4: card.num.slice(-4) } : null } });
  }

  return (
    <div className="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold">Checkout</h2>
        <button className="text-blue-500" onClick={onBack}>Back to cart</button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div className="md:col-span-2 space-y-3">
          <div className="p-3 bg-gray-50 dark:bg-gray-700 rounded">
            <h3 className="font-semibold">Delivery Address</h3>
            <input className="w-full p-2 mt-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Full name" value={addr.name} onChange={e => setAddr({ ...addr, name: e.target.value })} />
            <input className="w-full p-2 mt-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Address line" value={addr.line1} onChange={e => setAddr({ ...addr, line1: e.target.value })} />
            <div className="flex gap-2 mt-2">
              <input className="flex-1 p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="City" value={addr.city} onChange={e => setAddr({ ...addr, city: e.target.value })} />
              <input className="w-28 p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="PIN" value={addr.zip} onChange={e => setAddr({ ...addr, zip: e.target.value })} />
            </div>
          </div>

          <div className="p-3 bg-gray-50 dark:bg-gray-700 rounded">
            <h3 className="font-semibold">Payment</h3>
            <label className="flex items-center gap-2 mt-2"><input type="radio" checked={method === 'card'} onChange={() => setMethod('card')} /> Card</label>
            {method === 'card' && (
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2">
                <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Card number" value={card.num} onChange={e => setCard({ ...card, num: e.target.value })} />
                <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Name on card" value={card.name} onChange={e => setCard({ ...card, name: e.target.value })} />
                <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="MM/YY" value={card.exp} onChange={e => setCard({ ...card, exp: e.target.value })} />
                <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="CVV" value={card.cvv} onChange={e => setCard({ ...card, cvv: e.target.value })} />
              </div>
            )}
            <label className="flex items-center gap-2 mt-2"><input type="radio" checked={method === 'upi'} onChange={() => setMethod('upi')} /> UPI / Wallet</label>
            <label className="flex items-center gap-2 mt-2"><input type="radio" checked={method === 'cod'} onChange={() => setMethod('cod')} /> Cash on Delivery</label>
          </div>
        </div>

        <aside className="p-3 bg-gray-50 dark:bg-gray-700 rounded">
          <h3 className="font-semibold">Order Summary</h3>
          <div className="mt-2 space-y-2">
            {cart.map(i => (
              <div key={i.product.id} className="flex justify-between">
                <div className="text-sm">{i.product.title} × {i.quantity}</div>
                <div className="font-semibold">{formatINR(i.product.price * i.quantity)}</div>
              </div>
            ))}
          </div>
          <hr className="my-2" />
          <div className="flex justify-between font-semibold">{formatINR(total)}</div>
          <button className="mt-3 w-full bg-yellow-300 px-3 py-2 rounded" onClick={place}>Place order (demo)</button>
        </aside>
      </div>
    </div>
  );
}

function AddProductForm({ onBack, onCreate }) {
  const [form, setForm] = useState({
    title: '', category: 'Clothing', description: '', price: '', condition: 'Good', brand: '', images: []
  });
  const [imageFiles, setImageFiles] = useState([]);

  function handleFiles(e) {
    const files = Array.from(e.target.files || []);
    Promise.all(files.slice(0, 6).map(f => new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = () => res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(f);
    }))).then(urls => {
      setImageFiles(urls);
      setForm(prev => ({ ...prev, images: urls }));
    });
  }

  function submit() {
    if (!form.title || !form.description || !form.price) {
      alert('Please fill title, description and price.');
      return;
    }
    if (!form.images || form.images.length < 3) {
      alert('Please upload at least 3 images (different angles).');
      return;
    }
    const priceNum = parseInt(form.price);
    onCreate({ ...form, price: priceNum });
  }

  return (
    <div className="max-w-3xl mx-auto bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
      <div className="flex justify-between items-center mb-3">
        <h3 className="text-xl font-semibold">Create Listing</h3>
        <button className="text-blue-500" onClick={onBack}>Back</button>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Title" value={form.title} onChange={e => setForm({ ...form, title: e.target.value })} />
        <select className="p-2 border rounded dark:bg-gray-600 dark:text-white" value={form.category} onChange={e => setForm({ ...form, category: e.target.value })}>
          {CATEGORIES.filter(c => c !== 'All').map(c => <option key={c}>{c}</option>)}
        </select>
        <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Brand" value={form.brand} onChange={e => setForm({ ...form, brand: e.target.value })} />
        <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Condition" value={form.condition} onChange={e => setForm({ ...form, condition: e.target.value })} />
        <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Price (INR)" value={form.price} onChange={e => setForm({ ...form, price: e.target.value })} />
        <textarea className="p-2 border rounded sm:col-span-2 dark:bg-gray-600 dark:text-white" rows="3" placeholder="Description" value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} />
      </div>

      <div className="mt-3">
        <label className="block mb-2">Upload images (min 3) — you can use camera on mobile</label>
        <input type="file" accept="image/*" multiple capture="environment" onChange={handleFiles} />
        <div className="mt-2 flex gap-2 overflow-x-auto">
          {imageFiles.map((src, i) => (
            <div key={i} className="h-28 w-36 border-2 border-black rounded overflow-hidden">
              <img src={src} className="w-full h-full object-cover" />
            </div>
          ))}
        </div>
      </div>

      <button className="mt-4 bg-green-300 px-4 py-2 rounded" onClick={submit}>Submit listing</button>
    </div>
  );
}

function EditProductForm({ product, onBack, onUpdate }) {
  const [form, setForm] = useState({
    title: product.title || '',
    category: product.category || 'Clothing',
    description: product.description || '',
    price: product.price ? product.price.toString() : '',
    condition: product.condition || 'Good',
    brand: product.brand || '',
    images: product.images || []
  });
  const [imageFiles, setImageFiles] = useState(product.images || []);

  function handleFiles(e) {
    const files = Array.from(e.target.files || []);
    Promise.all(files.slice(0, 6).map(f => new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = () => res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(f);
    }))).then(urls => {
      setImageFiles(urls);
      setForm(prev => ({ ...prev, images: urls }));
    });
  }

  function submit() {
    if (!form.title || !form.description || !form.price) {
      alert('Please fill title, description, and price.');
      return;
    }
    if (!form.images || form.images.length < 3) {
      alert('Please upload at least 3 images (different angles).');
      return;
    }
    const priceNum = parseInt(form.price);
    onUpdate({ ...form, price: priceNum });
  }

  return (
    <div className="max-w-3xl mx-auto bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
      <div className="flex justify-between items-center mb-3">
        <h3 className="text-xl font-semibold">Edit Listing</h3>
        <button className="text-blue-500" onClick={onBack}>Back</button>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Title" value={form.title} onChange={e => setForm({ ...form, title: e.target.value })} />
        <select className="p-2 border rounded dark:bg-gray-600 dark:text-white" value={form.category} onChange={e => setForm({ ...form, category: e.target.value })}>
          {CATEGORIES.filter(c => c !== 'All').map(c => <option key={c}>{c}</option>)}
        </select>
        <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Brand" value={form.brand} onChange={e => setForm({ ...form, brand: e.target.value })} />
        <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Condition" value={form.condition} onChange={e => setForm({ ...form, condition: e.target.value })} />
        <input className="p-2 border rounded dark:bg-gray-600 dark:text-white" placeholder="Price (INR)" value={form.price} onChange={e => setForm({ ...form, price: e.target.value })} />
        <textarea className="p-2 border rounded sm:col-span-2 dark:bg-gray-600 dark:text-white" rows="3" placeholder="Description" value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} />
      </div>

      <div className="mt-3">
        <label className="block mb-2">Upload images (min 3) — you can use camera on mobile</label>
        <input type="file" accept="image/*" multiple capture="environment" onChange={handleFiles} />
        <div className="mt-2 flex gap-2 overflow-x-auto">
          {imageFiles.map((src, i) => (
            <div key={i} className="h-28 w-36 border-2 border-black rounded overflow-hidden">
              <img src={src} className="w-full h-full object-cover" />
            </div>
          ))}
        </div>
      </div>

      <button className="mt-4 bg-green-300 px-4 py-2 rounded" onClick={submit}>Update listing</button>
    </div>
  );
}

function Profile({ user, onBack, onLogout, purchases, products, onRemove, onEdit }) {
  const sold = products.filter(p => p.sellerId === (user?.id || 999));
  return (
    <div className="max-w-3xl mx-auto bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
      <div className="flex justify-between items-center mb-3">
        <h3 className="text-xl font-semibold">Profile</h3>
        <div>
          <button className="text-blue-500 mr-2" onClick={onBack}>Back</button>
          <button className="text-red-500" onClick={onLogout}>Logout</button>
        </div>
      </div>
      {user ? (
        <div>
          <div className="mb-3"><strong>Name:</strong> {user.name}</div>
          <div className="mb-3"><strong>Email:</strong> {user.email}</div>

          <h4 className="mt-4 font-semibold">Items you sold (listed)</h4>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">
            {sold.length === 0 && <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded">You haven't sold any items yet.</div>}
            {sold.map(p => (
              <div key={p.id} className="p-2 bg-gray-50 dark:bg-gray-700 rounded flex gap-2 items-center">
                <img src={p.images[0]} className="w-20 h-16 object-cover rounded border border-black" />
                <div className="flex-1">
                  <div className="font-semibold">{p.title}</div>
                  <div className="text-sm text-gray-500 dark:text-gray-300">{formatINR(p.price)}</div>
                  <div className="mt-2 flex gap-2">
                    <button onClick={() => onEdit(p.id)} className="text-blue-500">Edit</button>
                    <button onClick={() => onRemove(p.id)} className="text-red-500">Remove</button>
                  </div>
                </div>
              </div>
            ))}
          </div>

          <h4 className="mt-4 font-semibold">Purchase history</h4>
          <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded mt-2">(In this demo app purchases are not persisted.)</div>
        </div>
      ) : (
        <div>Please login to view profile.</div>
      )}
    </div>
  );
}

function FloatingSupportChat() {
  const [open, setOpen] = useState(false);
  const [msgs, setMsgs] = useState([{ text: 'Hello! How can we help? 👋', sender: 'owner', ts: Date.now() }]);
  const [input, setInput] = useState('');
  function send() {
    if (!input.trim()) return;
    setMsgs(prev => [...prev, { text: input.trim(), sender: 'you', ts: Date.now() }]);
    setInput('');
    setTimeout(() => setMsgs(prev => [...prev, { text: 'Thanks — we will reply soon!', sender: 'owner', ts: Date.now() + 1 }]), 800);
  }
  return (
    <div className="fixed bottom-4 right-4">
      <button className="bg-green-300 px-3 py-2 rounded-full shadow" onClick={() => setOpen(o => !o)}>{open ? 'Close' : 'Support'}</button>
      {open && (
        <div className="mt-2 w-72 bg-white dark:bg-gray-800 rounded-xl shadow p-2">
          <div className="h-48 overflow-y-auto space-y-2">
            {msgs.map((m, i) => (<div key={i} className={`p-2 rounded ${m.sender === 'you' ? 'bg-blue-100 self-end' : 'bg-green-100'}`}>{m.text}</div>))}
          </div>
          <div className="flex gap-2 mt-2">
            <input className="flex-1 p-2 border rounded dark:bg-gray-600 dark:text-white" value={input} onChange={e => setInput(e.target.value)} placeholder="Message..." />
            <button className="bg-purple-300 px-3 rounded text-white" onClick={send}>Send</button>
          </div>
        </div>
      )}
    </div>
  );
}

/* ---------- Render ---------- */
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
