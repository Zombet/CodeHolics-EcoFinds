<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EcoFinds</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

  <div id="app" class="w-full max-w-md"></div>

  <!-- Load Firebase config -->
  <script src="config.js"></script>

  <script>
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    const appDiv = document.getElementById('app');

    // Show Login Screen
    function showLogin() {
      appDiv.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h1 class="text-2xl font-bold mb-4 text-center">Login</h1>
          <input type="email" id="email" placeholder="Email" class="w-full p-2 mb-4 border rounded"/>
          <input type="password" id="password" placeholder="Password" class="w-full p-2 mb-2 border rounded"/>
          <p id="error" class="text-red-500 mb-2"></p>
          <button id="loginBtn" class="w-full bg-green-500 text-white p-2 rounded mb-2 hover:bg-green-600">Login</button>
          <button id="googleLoginBtn" class="w-full bg-blue-500 text-white p-2 rounded mb-2 hover:bg-blue-600">Login with Google</button>
          <button id="forgotBtn" class="w-full text-blue-500 hover:underline mb-2">Forgot Password?</button>
          <button id="signupBtn" class="w-full text-blue-500 hover:underline">Sign Up</button>
        </div>
      `;

      document.getElementById('loginBtn').onclick = async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const error = document.getElementById('error');
        error.textContent = '';
        try {
          await auth.signInWithEmailAndPassword(email, password);
          showHome(auth.currentUser);
        } catch(e) {
          error.textContent = e.message;
        }
      };

      document.getElementById('googleLoginBtn').onclick = async () => {
        try {
          await auth.signInWithPopup(googleProvider);
          showHome(auth.currentUser);
        } catch(e) {
          document.getElementById('error').textContent = e.message;
        }
      };

      document.getElementById('forgotBtn').onclick = async () => {
        const email = document.getElementById('email').value;
        const error = document.getElementById('error');
        error.textContent = '';
        if(!email) {
          error.textContent = "Enter your email to reset password";
          return;
        }
        try {
          await auth.sendPasswordResetEmail(email);
          alert("Password reset email sent!");
        } catch(e) {
          error.textContent = e.message;
        }
      };

      document.getElementById('signupBtn').onclick = showSignup;
    }

    // Show Signup Screen
    function showSignup() {
      appDiv.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h1 class="text-2xl font-bold mb-4 text-center">Sign Up</h1>
          <input type="text" id="username" placeholder="Username" class="w-full p-2 mb-4 border rounded"/>
          <input type="email" id="email" placeholder="Email" class="w-full p-2 mb-4 border rounded"/>
          <input type="password" id="password" placeholder="Password" class="w-full p-2 mb-1 border rounded"/>
          <input type="password" id="confirm" placeholder="Confirm Password" class="w-full p-2 mb-2 border rounded"/>
          <ul id="pwError" class="text-red-500 mb-2 list-disc list-inside"></ul>
          <p id="error" class="text-red-500 mb-2"></p>
          <button id="signupBtn" class="w-full bg-green-500 text-white p-2 rounded mb-2 hover:bg-green-600">Sign Up</button>
          <button id="backBtn" class="w-full text-blue-500 hover:underline">Back to Login</button>
        </div>
      `;

      const validatePassword = (pw) => {
        const errors = [];
        if(pw.length < 8) errors.push("At least 8 characters");
        if(!/[A-Z]/.test(pw)) errors.push("At least one uppercase letter");
        if(!/[a-z]/.test(pw)) errors.push("At least one lowercase letter");
        if(!/[0-9]/.test(pw)) errors.push("At least one number");
        if(!/[!@#$%^&*]/.test(pw)) errors.push("At least one special character (!@#$%^&*)");
        return errors;
      };

      document.getElementById('signupBtn').onclick = async () => {
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const confirm = document.getElementById('confirm').value;
        const error = document.getElementById('error');
        const pwError = document.getElementById('pwError');
        error.textContent = '';
        pwError.innerHTML = '';

        const errors = validatePassword(password);
        if(errors.length > 0) {
          pwError.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
          return;
        }

        if(password !== confirm) {
          error.textContent = "Passwords do not match";
          return;
        }

        try {
          await auth.createUserWithEmailAndPassword(email, password);
          await auth.currentUser.updateProfile({ displayName: username });
          showHome(auth.currentUser);
        } catch(e) {
          error.textContent = e.message;
        }
      };

      document.getElementById('backBtn').onclick = showLogin;
    }

    // Show Home Screen
    function showHome(user) {
      appDiv.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h1 class="text-2xl font-bold mb-4">Welcome, ${user.displayName || user.email}</h1>
          <button id="logoutBtn" class="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600">Logout</button>
        </div>
      `;

      document.getElementById('logoutBtn').onclick = async () => {
        await auth.signOut();
        showLogin();
      };
    }

    // Listen to auth state
    auth.onAuthStateChanged(user => {
      if(user) showHome(user);
      else showLogin();
    });

  </script>
</body>
</html>
